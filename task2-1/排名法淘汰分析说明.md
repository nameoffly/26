# 排名法淘汰分析说明文档

## 一、代码目标与背景

### 1.1 研究问题
本代码用于解决 **2026 MCM Problem C** 的第二个问题：对第 3-27 季的《与星共舞》节目，应用**排名法（Rank Method）**进行淘汰决策，并与**百分比法（Percentage Method）**的实际淘汰结果进行对比分析。

### 1.2 两种淘汰方法对比

#### 百分比法（节目实际使用）
- **综合得分** = 评委百分比 + 观众百分比
- 淘汰综合得分最低的 k 名选手

#### 排名法（本研究模拟）
- 对评委百分比排名（1 = 最好）
- 对观众百分比排名（1 = 最好）
- **综合排名** = 评委排名 + 观众排名（和越小越好）
- 淘汰综合排名和最大的 k 名选手

### 1.3 核心研究问题
1. 排名法与百分比法的淘汰结果有多大差异？
2. 当结果不同时，哪种方法更偏向观众意见？
3. **【新增】** 在决赛周，两种方法预测的最终排名与实际排名的准确性如何？

---

## 二、数据来源

### 2.1 输入数据文件

| 文件名 | 路径 | 内容 |
|--------|------|------|
| `Data_4.xlsx` | 项目根目录 | 包含评委百分比、实际淘汰结果、决赛排名信息 |
| `fan_vote_estimates_entropy_smooth_150.csv` | task2-1 目录 | 估计的观众投票百分比（来自问题一，λ=150） |

> **注意**：使用 `Data_4.xlsx` 而非 `2026_MCM_Problem_C_Processed_Data.xlsx`，因为前者包含正确的淘汰周信息（如第3季第9周 Joey Lawrence 被淘汰）。

### 2.2 输出数据文件

| 文件名 | 内容 |
|--------|------|
| `rank_vs_percent_elimination_150.csv` | 每周淘汰结果对比详细记录（含决赛排名信息） |

---

## 三、核心算法逻辑

### 3.1 排名规则详解

#### 排名计算方法
使用 `pandas.rank(ascending=False, method='min')`：
- **降序排名**：百分比最高者排名为 1
- **同分处理**：相同百分比的选手获得相同排名（取该组最小名次）
- **名次顺延**：例如两人并列第一（排名都是 1），下一名为第三（排名 3）

**示例：**
```
选手    百分比    排名
A       30%       1
B       30%       1    ← 并列第一
C       25%       3    ← 跳过 2，直接为 3
D       20%       4
```

#### 综合排名计算
```python
综合排名 = 评委排名 + 观众排名
```

**淘汰规则：**
- 综合排名和最大的 k 名选手被淘汰
- 若综合排名相同，则评委排名更差（数字更大）的优先淘汰

### 3.2 决赛周识别逻辑【新增】

#### 识别方法
```python
def get_final_week(season_df):
    """获取决赛周数（最大淘汰周+1）"""
    max_elim_week = get_max_elimination_week(season_df)
    return max_elim_week + 1 if max_elim_week > 0 else 0
```

**核心逻辑：**
1. 遍历所有周，找出有选手被淘汰的最大周数 `max_elim_week`
2. **决赛周 = max_elim_week + 1**
3. 验证条件：该周选手的 `results` 字段包含 "place"（如 "1st place"）且不包含 "eliminated"
4. 至少有 **2 位选手有排名信息**才确认是决赛

### 3.3 决赛排名计算【新增】

#### 百分比法决赛排名
```python
def compute_final_ranking_by_percent(names, judge_percents, fan_percents):
    """总分 = 评委% + 观众%，总分越高排名越前"""
    total = judge_percents + fan_percents
    order = np.argsort(-total)  # 降序
    rankings = {names[idx]: rank for rank, idx in enumerate(order, start=1)}
    return rankings
```

#### 排名法决赛排名
```python
def compute_final_ranking_by_rank_method(names, judge_percents, fan_percents):
    """综合排名 = 评委排名 + 观众排名，综合排名越小越好"""
    judge_rank = pd.Series(judge_percents).rank(ascending=False, method='min')
    fan_rank = pd.Series(fan_percents).rank(ascending=False, method='min')
    sum_rank = judge_rank + fan_rank
    # 按综合排名升序，同分时评委排名小的在前
    idx = np.lexsort((judge_rank, sum_rank))
    rankings = {names[i]: rank for rank, i in enumerate(idx, start=1)}
    return rankings
```

### 3.4 排名准确性评估【新增】

```python
def compare_ranking_accuracy(actual_rankings, method_rankings):
    """比较预测排名与实际排名的准确性"""
    return {
        'exact_match': bool,      # 完全一致
        'top1_correct': bool,     # 第一名正确
        'top2_correct': bool,     # 前两名正确（顺序也对）
        'kendall_tau': float,     # Kendall tau相关系数
        'displacement_sum': int,  # 排名位移总和
    }
```

| 指标 | 说明 | 理想值 |
|------|------|--------|
| `exact_match` | 预测排名与实际完全一致 | True |
| `top1_correct` | 冠军预测正确 | True |
| `top2_correct` | 前两名及顺序都正确 | True |
| `kendall_tau` | 排名相关系数 | 1.0 |
| `displacement_sum` | 各选手排名误差总和 | 0 |

### 3.5 核心函数说明

#### `apply_rank_method_one_week()`
**功能：** 对某一周的选手应用排名法，决定淘汰名单

**输入参数：**
- `names`: 选手名单
- `judge_percents`: 评委百分比数组
- `fan_percents`: 观众百分比数组
- `n_eliminate`: 需要淘汰的人数

**处理流程：**
```
1. 计算评委排名（降序，最高百分比=1）
2. 计算观众排名（降序，最高百分比=1）
3. 计算综合排名 = 评委排名 + 观众排名
4. 按综合排名降序排序，同分时评委排名更差的优先
5. 取前 n_eliminate 名选手作为淘汰名单
```

#### `run_rank_method_all_seasons()`
**功能：** 遍历第 3-27 季的所有周，应用排名法并与百分比法对比

**处理流程：**
```
对每一季：
  计算决赛周数 final_week
  对每一周：
    1. 获取该周参赛选手、评委百分比
    2. 从估计数据获取观众百分比
    3. 获取百分比法实际淘汰名单
    4. 应用排名法得到淘汰名单
    5. 比较两种方法的淘汰结果是否一致
    6. 记录差异（如果有）
    7. 【新增】如果是决赛周，计算并记录两种方法的排名信息
```

**返回值：**
- `DataFrame`: 每周对比结果（包含淘汰和决赛排名信息）
- `list`: 淘汰差异详情
- `list`: 决赛排名结果详情

---

## 四、差异分析方法

### 4.1 分析目标
当排名法和百分比法淘汰结果不同时，判断**哪种方法更偏向观众意见**。

### 4.2 分析逻辑

#### 核心假设
1. **观众投票占比高** = 该选手受观众欢迎
2. **某方法保留了高观众人气的选手** = 该方法更偏向观众

#### 分析指标

定义两类差异选手：
- **仅百分比法淘汰**：在百分比法下被淘汰，但排名法下被保留
- **仅排名法淘汰**：在排名法下被淘汰，但百分比法下被保留

对每类选手，比较其观众投票占比与该周平均值：

| 选手类型 | 观众占比特征 | 说明 | 倾向判断 |
|---------|-------------|------|---------|
| 仅百分比法淘汰 | 高于平均 | 排名法保留了高人气选手 | **排名法更偏观众** |
| 仅排名法淘汰 | 低于平均 | 排名法淘汰了低人气选手 | **排名法更偏观众** |
| 仅百分比法淘汰 | 低于平均 | 百分比法淘汰了低人气选手 | **百分比法更偏观众** |
| 仅排名法淘汰 | 高于平均 | 百分比法保留了高人气选手 | **百分比法更偏观众** |

---

## 五、运行结果【更新】

### 5.1 淘汰结果对比统计

| 统计项 | 数值 |
|--------|------|
| 总周数（有选手参与） | 248 |
| 无人淘汰周数 | 53 |
| 有人淘汰周数 | 195 |
| 淘汰结果一致周数 | 117 |
| 淘汰结果不同周数 | 78 |
| **一致比例** | **60.0%** |

### 5.2 方法偏向分析

| 统计项 | 数值 |
|--------|------|
| 排名法更偏观众的次数 | 68 |
| 百分比法更偏观众的次数 | 87 |

**结论**：当淘汰结果不同时，多数情况下百分比法更偏向观众意见。

### 5.3 决赛排名准确性【新增】

| 指标 | 百分比法 | 排名法 |
|------|---------|-------|
| 完全正确 | **25季 (100.0%)** | 16季 (64.0%) |
| 第一名正确 | **25季 (100.0%)** | 22季 (88.0%) |
| 前两名正确 | **25季 (100.0%)** | 16季 (64.0%) |
| 平均 Kendall τ | **1.0000** | 0.7467 |
| 总排名位移 | **0** | 30 |

**结论**：
- 百分比法在预测冠军方面更准确 (25 vs 22)
- 百分比法在预测完整排名方面更准确 (25 vs 16)
- 百分比法实现了 100% 的决赛排名准确率

### 5.4 决赛排名详情示例

```
【第 3 季 第 10 周决赛】 (2 位选手)
  实际排名:   Emmitt Smith(1) > Mario Lopez(2)
  百分比法:   Emmitt Smith(1) > Mario Lopez(2) ✓完全正确
  排名法:     Emmitt Smith(1) > Mario Lopez(2) ✓完全正确

【第 7 季 第 10 周决赛】 (3 位选手)
  实际排名:   Brooke Burke(1) > Warren Sapp(2) > Lance Bass(3)
  百分比法:   Brooke Burke(1) > Warren Sapp(2) > Lance Bass(3) ✓完全正确
  排名法:     Warren Sapp(1) > Brooke Burke(2) > Lance Bass(3) ✗

【第 27 季 第 9 周决赛】 (4 位选手)
  实际排名:   Bobby Bones(1) > Milo Manheim(2) > Evanna Lynch(3) > Alexis Ren(4)
  百分比法:   Bobby Bones(1) > Milo Manheim(2) > Evanna Lynch(3) > Alexis Ren(4) ✓完全正确
  排名法:     Milo Manheim(1) > Evanna Lynch(2) > Alexis Ren(3) > Bobby Bones(4) ✗
```

---

## 六、CSV 输出文件字段说明【更新】

`rank_vs_percent_elimination_150.csv` 包含以下字段：

### 6.1 基本字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| `season` | 季数 | 3 |
| `week` | 周数 | 10 |
| `n_contestants` | 该周参赛选手数 | 2 |
| `n_eliminated` | 淘汰人数 | 0 |
| `percent_eliminated` | 百分比法淘汰名单（逗号分隔） | "Joey Lawrence" |
| `rank_eliminated` | 排名法淘汰名单（逗号分隔） | "Joey Lawrence" |
| `same_result` | 两种方法结果是否一致 | True |

### 6.2 决赛排名字段【新增】

| 字段名 | 说明 | 示例 |
|--------|------|------|
| `is_final` | 是否为决赛周 | True |
| `actual_ranking` | 实际排名（`>`分隔） | "Emmitt Smith>Mario Lopez" |
| `percent_ranking` | 百分比法预测排名 | "Emmitt Smith>Mario Lopez" |
| `rank_method_ranking` | 排名法预测排名 | "Emmitt Smith>Mario Lopez" |
| `percent_exact_match` | 百分比法是否完全正确 | True |
| `rank_exact_match` | 排名法是否完全正确 | True |
| `percent_top1_correct` | 百分比法冠军是否正确 | True |
| `rank_top1_correct` | 排名法冠军是否正确 | True |

> 非决赛周的决赛相关字段为空或 False。

---

## 七、使用方法

### 7.1 运行环境要求
```bash
# Python 依赖
pip install pandas numpy openpyxl
```

### 7.2 文件准备
确保以下文件存在：
```
2026_C/
├── Data_4.xlsx                               # 评委数据和实际淘汰
└── task2-1/
    ├── rank_method_elimination.py            # 本代码
    └── fan_vote_estimates_entropy_smooth_150.csv  # 观众估计（来自问题一）
```

### 7.3 运行代码
```bash
cd task2-1
python rank_method_elimination.py
```

### 7.4 输出示例
```
============================================================
问题二：排名法 vs 百分比法 淘汰结果比较（第3-27季）
============================================================
评委数据: D:\...\Data_4.xlsx
观众估计: D:\...\fan_vote_estimates_entropy_smooth_150.csv

总周数（有选手参与）: 248
  其中无人淘汰周数: 53
  其中有人淘汰周数: 195
淘汰结果一致周数: 117
淘汰结果不同周数: 78
一致比例（仅统计有淘汰的周数）: 60.0%

每周对比已保存: rank_vs_percent_elimination_150.csv

淘汰结果不同的部分周（前20个）：
------------------------------------------------------------
  第3季 第3周:
    百分比法淘汰: ['Harry Hamlin']
    排名法淘汰:   ['Jerry Springer']
    ...

================================================================================
决赛排名准确性分析
================================================================================

共 25 季有决赛排名数据

--------------------------------------------------------------------------------
【第 3 季 第 10 周决赛】 (2 位选手)
  实际排名:   Emmitt Smith(1) > Mario Lopez(2)
  百分比法:   Emmitt Smith(1) > Mario Lopez(2) ✓完全正确
  排名法:     Emmitt Smith(1) > Mario Lopez(2) ✓完全正确
...

【汇总统计】(25 季决赛)
--------------------------------------------------
         指标          |     百分比法     |     排名法     
--------------------------------------------------
        完全正确         |   25   (100.0%) |   16   ( 64.0%)
       第一名正确         |   25   (100.0%) |   22   ( 88.0%)
       前两名正确         |   25   (100.0%) |   16   ( 64.0%)
    平均Kendall τ      |    1.0000    |    0.7467   
       总排名位移         |      0       |      30     
--------------------------------------------------

【决赛排名准确性结论】
  百分比法在预测冠军方面更准确 (25 vs 22)
  百分比法在预测完整排名方面更准确 (25 vs 16)
```

---

## 八、技术细节

### 8.1 排序中的同分处理

**lexsort 双重排序：**
```python
idx = np.lexsort((-judge_rank, -sum_rank))
```

- **第一关键字**：`-sum_rank`（综合排名降序）
- **第二关键字**：`-judge_rank`（评委排名降序）

**效果：**
- 优先按综合排名排序
- 综合排名相同时，评委排名更差（数字更大）的排在前面（优先淘汰）

### 8.2 决赛排名的排序逻辑

**排名法决赛排名：**
```python
idx = np.lexsort((judge_rank, sum_rank))  # 升序
```
- **第一关键字**：`sum_rank`（综合排名升序，越小越好）
- **第二关键字**：`judge_rank`（同分时评委排名小的在前）

### 8.3 编码处理

```python
if sys.stdout.encoding != 'utf-8':
    try:
        sys.stdout.reconfigure(encoding='utf-8')
    except Exception:
        pass
```

确保中文选手名字能正确显示在终端。

### 8.4 数据匹配策略

**观众百分比获取：**
```python
week_fan = fan_season[fan_season['week'] == week]
name_to_fan = dict(zip(week_fan['celebrity_name'], week_fan['fan_vote_percent']))
fan_percents = np.array([name_to_fan.get(n, 0.0) for n in names])
```

- 建立选手名到观众百分比的字典映射
- 使用 `get(n, 0.0)` 确保找不到时默认为 0%

---

## 九、统计指标说明

### 9.1 淘汰对比指标

| 指标 | 说明 | 计算方法 |
|------|------|---------|
| **总周数** | 有选手参与的所有周数 | 遍历第3-27季所有周 |
| **无人淘汰周数** | n_eliminated = 0 的周数 | 统计 `df[df['n_eliminated'] == 0]` |
| **有人淘汰周数** | n_eliminated > 0 的周数 | 统计 `df[df['n_eliminated'] > 0]` |
| **淘汰结果一致周数** | 两种方法淘汰名单完全相同 | 在有人淘汰的周数中统计 `same_result == True` |
| **淘汰结果不同周数** | 两种方法淘汰名单不同 | 在有人淘汰的周数中统计 `same_result == False` |
| **一致比例** | 结果一致周数占比 | `same_weeks / weeks_with_elimination × 100%` |

### 9.2 决赛排名指标【新增】

| 指标 | 说明 | 理想值 |
|------|------|--------|
| **完全正确** | 预测排名与实际排名完全一致的季数 | 25季 |
| **第一名正确** | 冠军预测正确的季数 | 25季 |
| **前两名正确** | 冠军和亚军都正确的季数 | 25季 |
| **平均 Kendall τ** | 排名相关系数平均值 | 1.0 |
| **总排名位移** | 各选手排名误差的总和 | 0 |

### 9.3 重要设计：排除无人淘汰周数

**为什么要排除？**
- 当某周无人淘汰（n_eliminated = 0）时，两种方法都不淘汰任何人
- 这种情况下"一致"是平凡的，不反映两种方法的实质差异
- 将其纳入统计会人为提高"一致比例"

---

## 十、结论总结【新增】

### 10.1 淘汰结果对比

1. **一致性分析**：在有淘汰的195周中，两种方法淘汰结果一致的有117周（60%）
2. **差异分析**：当结果不同时，百分比法略微更偏向观众意见（87 vs 68）

### 10.2 决赛排名准确性

1. **百分比法表现优异**：100%准确预测所有25季的决赛排名
2. **排名法存在误差**：仅64%的季度完全正确，88%的季度冠军正确
3. **典型失误案例**：
   - 第7季：排名法错判 Warren Sapp 为冠军（实际冠军 Brooke Burke）
   - 第27季：排名法将 Bobby Bones 排在第4名（实际冠军）

### 10.3 方法特点

| 方法 | 优点 | 缺点 |
|------|------|------|
| 百分比法 | 决赛排名准确率高；能反映绝对分数差异 | 可能忽略观众的相对偏好 |
| 排名法 | 消除分数尺度影响；突出相对位置 | 决赛预测不如百分比法准确 |

---

## 十一、注意事项与局限性

### 11.1 数据质量依赖
- 观众投票百分比来自问题一的**估计结果**（`fan_vote_estimates_entropy_smooth_150.csv`）
- 估计误差会影响排名法的淘汰结果
- 不同的平滑参数（如 λ=100 vs λ=150）会导致略有不同的对比结果

### 11.2 排名法的理论假设
- 假设排名的重要性是**线性可加的**（评委排名 + 观众排名）
- 实际中，排名差异的"重要性"可能是非线性的

### 11.3 同分处理的影响
- 使用 `method='min'` 的排名策略（并列取最小名次）
- 不同的同分处理方式可能影响最终淘汰结果

### 11.4 统计样本量
- 分析第 3-27 季（25 季）
- 总样本 248 周（排除无人淘汰周后 195 周）
- 决赛样本 25 季

---

## 十二、扩展与改进方向

### 12.1 敏感性分析
- 改变排名规则（如使用 `method='average'` 而非 `method='min'`）
- 改变同分时的优先级（如优先淘汰观众排名差的）
- 使用不同平滑参数的观众估计结果

### 12.2 加权排名法
```python
综合排名 = α × 评委排名 + (1-α) × 观众排名
```
分析不同权重 α 下的淘汰结果。

### 12.3 可视化分析
- 绘制一致比例随季数变化的趋势图
- 差异周的选手百分比分布散点图
- 评委排名 vs 观众排名的二维热力图
- **【新增】** 决赛排名准确性随季度变化的趋势图

### 12.4 统计检验
- 使用卡方检验判断两种方法差异的显著性
- Bootstrap 重采样估计一致比例的置信区间

---

## 十三、引用与参考

### 13.1 数据来源
- 原始数据：`Data_4.xlsx`
- 观众估计：`task1-1/fan_vote_estimation_entropy_smooth.py` 生成的 `fan_vote_estimates_entropy_smooth_150.csv`

### 13.2 相关文件
- **问题一代码**：`task1-1/fan_vote_estimation_entropy_smooth.py`（观众投票估计）
- **问题一说明**：`task1-1/观众投票估计模型使用说明.md`

### 13.3 问题背景
参见 **2026 MCM Problem C** 题目描述和 Appendix 中的排名法规则说明。

---

## 联系与反馈

如有疑问或改进建议，请联系项目维护者。

---

**最后更新时间：** 2026年1月31日
