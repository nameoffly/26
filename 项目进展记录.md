# MCM 2026 Problem C 项目进展记录

## 一、项目背景

### 1.1 问题描述

针对 **2026 MCM Problem C: Data With The Stars**，研究 Dancing with the Stars (DWTS) 节目中的评委评分与观众投票机制。

### 1.2 核心任务（问题一）

**目标**：估计每位选手在其参赛各周的观众投票百分比。

**背景**：

- 观众投票数据是保密的，只有淘汰结果是已知的
- 第3-27季使用**百分比方法**合并评委和观众投票
- 总百分比 = 评委评分百分比 + 观众投票百分比
- 总百分比最低的选手被淘汰

---

## 二、数据文件

### 2.1 原始数据

- `2026_MCM_Problem_C_Data.csv` - 原始CSV数据（421位选手）
- `2026_MCM_Problem_C.pdf` - 问题描述文档

### 2.2 处理后的数据

- `2026_MCM_Problem_C_Processed_Data.xlsx` - 处理后的Excel文件
  - 包含 `1_percent` 到 `11_percent` 列：每周评委评分百分比（已计算好）
  - 包含 `results` 列：淘汰结果（如 "Eliminated Week 3"）
  - 包含 `placement` 列：最终名次

---

## 三、已完成的工作

### 3.1 数学建模

建立了基于**线性约束优化**的观众投票估计模型：

**决策变量**：$v_i$ = 选手i的观众投票百分比

**约束条件**：

1. 归一化：$\sum v_i = 1$
2. 非负性：$v_i \geq 0$
3. 淘汰约束：$T_e < T_s$（淘汰者总分 < 幸存者总分）

### 3.2 三种正则化方法

#### 方法一：最小方差正则化

- **目标函数**：$\min \sum v_i^2$
- **假设**：观众投票在选手间尽可能均匀分布
- **代码文件**：`fan_vote_estimation.py`
- **结果文件**：
  - `fan_vote_estimates.csv`
  - `fan_vote_estimates_with_confidence.csv`

#### 方法二：平滑性正则化

- **目标函数**：$\min \sum_i \sum_t (v_{i,t} - v_{i,t-1})^2$
- **假设**：选手的粉丝基础在相邻周之间变化尽可能小
- **两步求解**：
  1. 先求解每个选手每周的可行区间 $[v_{min}, v_{max}]$（线性规划，兼容 scipy 多方法：highs / interior-point / simplex）
  2. 再进行跨周联合优化，最小化相邻周变化
- **代码文件**：`fan_vote_estimation_smooth.py`
- **结果文件**：`fan_vote_estimates_smooth.csv`
- **重要修复**：可行区间计算曾因 `linprog(method='highs')` 在旧版 scipy 下报错而默认返回 [0,1]；已改为按方法列表尝试，保证被淘汰者区间上界正确（如 Tucker Carlson 第1周应为 [0, 12.43%] 而非 [0, 100%]）。

#### 方法三：最大熵+平滑性联合正则化

- **目标函数**：$\max \sum_t H_t(v) - \lambda \sum_{t,i} (v_{i,t} - v_{i,t-1})^2$，等价于 $\min \sum_t \sum_i v_{i,t}\log v_{i,t} + \lambda \sum_{t,i}(v_{i,t}-v_{i,t-1})^2$
- **假设**：每周分布尽量均匀（最大熵）+ 同一选手相邻周变化尽量小（平滑性）
- **参数**：`lambda_smooth` 默认 10.0；λ 越大越强调时间连续性，λ 越小越强调每周均匀性
- **代码文件**：`fan_vote_estimation_entropy_smooth.py`
- **结果文件**：`fan_vote_estimates_entropy_smooth.csv`

### 3.3 验证结果与一致性指标

三种方法均实现：

- **约束满足率：100%**（所有淘汰者总分 < 所有幸存者总分）
- 处理了 25 个季度、248 周、1997 个选手-周估计

**一致性指标说明**：

- **约束满足率**：用淘汰约束来估计时，该指标必然 100%，不能单独作为“预测能力”的度量。
- **无约束预测准确率**（建议补充）：去掉淘汰约束、仅用正则化估计后，看“总分最低者是否为实际淘汰者”的比例，才能衡量模型真实预测能力。
- **平均边际余量**：$\min_s T_s - \max_e T_e$ 的周平均；越大表示淘汰结果越“确定”，越小（接近 ε）表示越“勉强”。
- **平均平滑度**：同一选手相邻周投票变化的平方和的平均；越小表示时间上越平滑。可用于选 λ（希望平滑度小、边际余量大时，可做 λ 网格搜索或帕累托前沿）。

### 3.4 问题一第二问：估计的确定性分析

**目标**：量化观众投票百分比估计的确定性，并说明不同选手/周是否具有一致的确定性。

**实现**：`fan_vote_certainty_analysis.py`，输入为 `fan_vote_estimates_entropy_smooth_100.csv`（λ=100 的估计结果）。

- **方法一（可行域区间法）**：对每位选手每周，不确定性度量 $w_{s,i,t} = v_{s,i,t}^{max} - v_{s,i,t}^{min}$（即 CSV 中的 `interval_width`）。汇总：按是否淘汰分组统计区间宽度的均值、标准差等，输出 `certainty_method1_interval_summary.csv`。
- **方法二（扰动-重建 Bootstrap 法）**：对评委打分加噪声 $J'_{s,i,t} = J_{s,i,t} + \eta_{s,i,t}$（$\eta \sim N(0,\sigma^2)$，默认 σ=0.01），重新求解最大熵+平滑性模型得到 $v^{(b)}$；经 B 次（默认 15）重复后，对每位选手每周计算样本方差 $\mathrm{Var}(v)$ 和 95% 分位数区间 $[Q_{2.5\%}, Q_{97.5\%}]$，输出 `certainty_method2_bootstrap.csv`。
- **合并输出**：`certainty_combined.csv`（含区间宽度与 Bootstrap 方差/置信区间）。

**结果要点**：方法一汇总显示，被淘汰者区间宽度均值远小于幸存者（约束更紧、估计更确定）；无淘汰周的平均区间宽度为 1，有淘汰周平均区间宽度小于 1。方法二可得到每个选手每周的方差与 95% 置信区间，用于检验“越接近淘汰边界的选手/周不确定性越大”等结论。

### 3.5 争议性选手分析

以 **Bobby Bones（第27季冠军）** 为例：

| 周 | 评委%  | 最小方差(观众%) | 平滑性(观众%)    |
| -- | ------ | --------------- | ---------------- |
| 1  | 7.84%  | 7.69%           | **22.50%** |
| 5  | 9.46%  | 11.11%          | **22.77%** |
| 9  | 23.38% | 25.00%          | 25.00%           |

**结论**：平滑性方法更好地解释了 Bobby Bones 的夺冠——他从一开始就拥有稳定的高粉丝支持（~22-25%）。

---

## 四、项目文件清单

```
d:\Users\13016\Desktop\26MCM\2026_C\
│
├── 数据文件（根目录）
│   ├── 2026_MCM_Problem_C_Data.csv            # 原始数据
│   ├── 2026_MCM_Problem_C_Processed_Data.xlsx # 处理后数据（主要使用）
│   └── 2026_MCM_Problem_C.pdf                 # 问题描述
│
└── task1-1\                                   # 问题一：观众投票估计
    │
    ├── 代码文件
    │   ├── fan_vote_estimation.py             # 最小方差正则化版本
    │   ├── fan_vote_estimation_smooth.py      # 平滑性正则化版本
    │   ├── fan_vote_estimation_entropy_smooth.py # 最大熵+平滑性联合正则化版本
    │   └── fan_vote_certainty_analysis.py     # 问题一第二问：确定性分析（区间+Bootstrap）
    │
    ├── 结果文件
    │   ├── fan_vote_estimates.csv             # 最小方差版本结果
    │   ├── fan_vote_estimates_with_confidence.csv # 最小方差版本（含置信度）
    │   ├── fan_vote_estimates_smooth.csv      # 平滑性版本结果
    │   ├── fan_vote_estimates_entropy_smooth.csv  # 最大熵+平滑性版本结果（λ=10）
    │   ├── fan_vote_estimates_entropy_smooth_100.csv # λ=100 估计结果（供确定性分析输入）
    │   ├── certainty_method1_interval_summary.csv  # 确定性方法一汇总
    │   ├── certainty_method2_bootstrap.csv    # 确定性方法二（Bootstrap 方差与置信区间）
    │   └── certainty_combined.csv            # 两种确定性结果合并
    │
    ├── 文档文件
    │   ├── 观众投票估计数学模型.md            # 数学模型详细推导
    │   ├── 观众投票估计模型使用说明.md        # 代码和结果说明
    │   └── 项目进展记录.md                    # 本文档
    │
    └── 配置文件
        └── requirements.txt                    # Python依赖
```

---

## 五、结果文件字段说明

### 5.1 通用字段

| 字段                 | 说明                               |
| -------------------- | ---------------------------------- |
| `season`           | 季度（3-27）                       |
| `week`             | 周数                               |
| `celebrity_name`   | 选手名字                           |
| `judge_percent`    | 评委评分百分比（已知）             |
| `fan_vote_percent` | 观众投票百分比（**估计值**） |
| `total_percent`    | 总百分比 = judge + fan             |
| `eliminated`       | 本周是否被淘汰                     |

### 5.2 平滑性版本特有

| 字段               | 说明             |
| ------------------ | ---------------- |
| `fan_vote_min`   | 观众投票可行下界 |
| `fan_vote_max`   | 观众投票可行上界 |
| `interval_width` | 可行区间宽度     |

### 5.3 最大熵+平滑性版本特有

| 字段             | 说明                                     |
| ---------------- | ---------------------------------------- |
| `smoothness`   | 该选手的平滑度（相邻周变化的平方和平均） |
| `n_weeks`      | 该选手参赛周数                           |
| `week_entropy` | 该周投票分布的熵值                       |

---

## 六、下一步工作建议

根据 MCM Problem C 的要求，还需要完成：

1. **问题一补充**：
   - 模型一致性度量（已完成：100%约束满足率）
   - 估计置信度/不确定性分析（已完成：可行域区间法 + 扰动-重建 Bootstrap 法，见 `fan_vote_certainty_analysis.py`）
2. **问题二**：比较百分比方法和排名方法

   - 将两种方法应用于所有季度
   - 分析结果差异
   - 研究是否一种方法更偏向观众投票
3. **问题三**：分析专业舞伴和明星特征的影响

   - 明星年龄、行业、地区等特征
   - 专业舞伴的影响
4. **问题四**：提出新的投票合并系统

---

## 七、技术要点

### 7.1 数据读取

使用处理后的Excel文件，评委百分比已在 `{week}_percent` 列中计算好：

```python
import pandas as pd
df = pd.read_excel('2026_MCM_Problem_C_Processed_Data.xlsx')
# week 1 的评委百分比在 '1_percent' 列
```

### 7.2 淘汰判断

从 `results` 列解析：

```python
# 判断是否在第k周被淘汰
eliminated = 'eliminated week k' in row['results'].lower()
```

### 7.3 优化求解

- 优先使用 `cvxpy`（二次规划求解器）
- 备用 `scipy.optimize`（SLSQP方法）

---

## 八、关键代码调用示例

```python
# 最小方差版本
from fan_vote_estimation import run_estimation
results = run_estimation(
    excel_path='2026_MCM_Problem_C_Processed_Data.xlsx',
    output_path='fan_vote_estimates.csv'
)

# 平滑性版本
from fan_vote_estimation_smooth import run_estimation
results = run_estimation(
    excel_path='2026_MCM_Problem_C_Processed_Data.xlsx',
    output_path='fan_vote_estimates_smooth.csv'
)

# 最大熵+平滑性版本（λ 可调，默认 10.0）
from fan_vote_estimation_entropy_smooth import run_estimation
results = run_estimation(
    excel_path='2026_MCM_Problem_C_Processed_Data.xlsx',
    output_path='fan_vote_estimates_entropy_smooth.csv',
    lambda_smooth=10.0
)
```

---

## 九、近期记忆与待办

- **一致性指标**：约束满足率 100% 是硬约束下的必然结果；建议增加“无约束预测准确率”衡量真实预测能力；平均边际余量、平均平滑度可用于评估解的确定性与时间平滑性。
- **λ 选择**：希望平均平滑度更小、平均边际余量更大时，可对 `lambda_smooth` 做网格搜索或帕累托前沿分析（代码中已有 `compare_lambda_values` 可扩展）。
- **当前默认**：最大熵+平滑性模型使用 `lambda_smooth=10.0`，结果已写入 `fan_vote_estimates_entropy_smooth.csv`；λ=100 结果用于确定性分析，见 `fan_vote_estimates_entropy_smooth_100.csv`。
- **确定性分析**：问题一第二问采用两种方式——（1）可行域区间法：用 `interval_width` 作不确定性，按是否淘汰、是否有淘汰周汇总；（2）Bootstrap 法：对评委分加噪声后重解，得到样本方差与 95% 分位数区间。脚本 `fan_vote_certainty_analysis.py` 默认读入 `fan_vote_estimates_entropy_smooth_100.csv`，可指定 `--B`、`--sigma` 等。

---

*文档创建时间：2026年1月30日*
*最后更新：问题一第二问确定性分析完成；项目进展记录与使用说明已同步*
